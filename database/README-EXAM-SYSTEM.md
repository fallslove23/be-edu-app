# ì‹œí—˜ ê´€ë¦¬ ì‹œìŠ¤í…œ ì™„ì „íŒ

BS Learning Management Systemì˜ í™•ì¥ ê°€ëŠ¥í•œ ì‹œí—˜ ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

- [ê°œìš”](#ê°œìš”)
- [ì§€ì› ì‹œë‚˜ë¦¬ì˜¤](#ì§€ì›-ì‹œë‚˜ë¦¬ì˜¤)
- [ë°ì´í„° êµ¬ì¡°](#ë°ì´í„°-êµ¬ì¡°)
- [ì„¤ì¹˜ ë°©ë²•](#ì„¤ì¹˜-ë°©ë²•)
- [ì‚¬ìš© ì˜ˆì œ](#ì‚¬ìš©-ì˜ˆì œ)
- [API ê°€ì´ë“œ](#api-ê°€ì´ë“œ)

## ğŸ¯ ê°œìš”

ì‹¤ì œ êµìœ¡ í™˜ê²½ì˜ ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì§€ì›í•˜ëŠ” LMS í‘œì¤€ ì‹œí—˜ ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### í•µì‹¬ ê¸°ëŠ¥

- âœ… **ê³¼ì • í…œí”Œë¦¿ ì¬ì‚¬ìš©**: "BS ì˜ì—… ê¸°ì´ˆê³¼ì •" ê°™ì€ ê³¼ì • ì„¤ê³„ ì¬ì‚¬ìš©
- âœ… **ì°¨ìˆ˜ë³„ ìš´ì˜**: "2024ë…„ 1ì°¨", "2024ë…„ 2ì°¨" ë“± ì°¨ìˆ˜ ê´€ë¦¬
- âœ… **ë¶„ë°˜ ì‹œìŠ¤í…œ**: ê°™ì€ ì°¨ìˆ˜ ë‚´ Aë°˜, Bë°˜ ë“± ë¶„ë°˜ ìš´ì˜
- âœ… **ìœ ì—°í•œ ì‹œí—˜ ë°°ì •**: í…œí”Œë¦¿/ì°¨ìˆ˜/ë¶„ë°˜ ìˆ˜ì¤€ì˜ 3-level ì‹œí—˜ ì—°ê²°
- âœ… **ë‹¤ì¤‘ ëŒ€ìƒ ì‹œí—˜**: í•©ë°˜, í†µí•© ì‹œí—˜ ì§€ì›
- âœ… **ë¬¸ì œì€í–‰**: ë¬¸ì œ ì¬ì‚¬ìš© ë° ì²´ê³„ì  ê´€ë¦¬
- âœ… **ìë™ ì±„ì **: ê°ê´€ì‹/O/X ìë™ ì±„ì , ì£¼ê´€ì‹ ìˆ˜ë™ ì±„ì 
- âœ… **í†µê³„ ë° ë¶„ì„**: ë¶„ë°˜ë³„, ì°¨ìˆ˜ë³„ ì„±ì  í†µê³„

## ğŸ« ì§€ì› ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì°¨ìˆ˜ë‹¹ 1ê°œ ì‹œí—˜ (ì¢…í•©í‰ê°€)
```
BS ì˜ì—… ê¸°ì´ˆê³¼ì • 2024ë…„ 1ì°¨
â””â”€â”€ ì¢…í•©í‰ê°€ ì‹œí—˜ (2024-08-15, 1íšŒ)
    â””â”€â”€ ì‘ì‹œì: 1ì°¨ ë“±ë¡ êµìœ¡ìƒ 25ëª…
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: í•˜ë£¨ ì—¬ëŸ¬ ì‹œí—˜ (ì¼ì¼ í€´ì¦ˆ)
```
BS ê³ ê¸‰ ì „ëµê³¼ì • 2024ë…„ 1ì°¨
â”œâ”€â”€ Day 1 Quiz (08-20, ì˜¤ì „ 10ì‹œ)
â”œâ”€â”€ Day 1 ì‹¤ìŠµí‰ê°€ (08-20, ì˜¤í›„ 3ì‹œ)
â”œâ”€â”€ Day 2 Quiz (08-21, ì˜¤ì „ 10ì‹œ)
â””â”€â”€ ìµœì¢…í‰ê°€ (09-05, ì˜¤ì „ 10ì‹œ)
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë¶„ë°˜ ì‹œí—˜ (ê°™ì€ ì°¨ìˆ˜, ë‹¤ë¥¸ ë°˜)
```
BS ì˜ì—… ê¸°ì´ˆê³¼ì • 2024ë…„ 3ì°¨
â”œâ”€â”€ 3ì°¨ Aë°˜ (ê°•ì‚¬: ê¹€ê°•ì‚¬, 30ëª…)
â”‚   â””â”€â”€ Day 1 Quiz (ë§¤ì¼ ì˜¤ì „ 10ì‹œ)
â””â”€â”€ 3ì°¨ Bë°˜ (ê°•ì‚¬: ì´ê°•ì‚¬, 28ëª…)
    â””â”€â”€ Day 1 Quiz (ë§¤ì¼ ì˜¤ì „ 11ì‹œ)
```

### ì‹œë‚˜ë¦¬ì˜¤ 4: í†µí•© ì‹œí—˜ (A+Bë°˜ ë™ì¼ ì‹œí—˜)
```
BS ì˜ì—… ê¸°ì´ˆê³¼ì • 2024ë…„ 3ì°¨ (A+Bë°˜)
â””â”€â”€ ìµœì¢…í‰ê°€ (10-15 ì˜¤ì „ 10ì‹œ)
    â””â”€â”€ ì‘ì‹œì: Aë°˜ 30ëª… + Bë°˜ 28ëª… = 58ëª…
```

### ì‹œë‚˜ë¦¬ì˜¤ 5: í•©ë°˜ ì‹œí—˜ (ì—¬ëŸ¬ ì°¨ìˆ˜ í†µí•©)
```
BS ê³ ê¸‰ ì „ëµê³¼ì •
â”œâ”€â”€ 2024ë…„ 1ì°¨ (25ëª…)
â””â”€â”€ 2024ë…„ 2ì°¨ (30ëª…)
    â””â”€â”€ ê³µë™ ìµœì¢…í‰ê°€
        â””â”€â”€ ì‘ì‹œì: 1ì°¨+2ì°¨ í•©ê³„ 55ëª…
```

## ğŸ—ï¸ ë°ì´í„° êµ¬ì¡°

### ê³„ì¸µ êµ¬ì¡°
```
Course Template (ê³¼ì • í…œí”Œë¦¿)
  â””â”€â”€ Course Session (ê³¼ì • ì°¨ìˆ˜)
        â””â”€â”€ Class Division (ë¶„ë°˜)
              â””â”€â”€ Enrollment (êµìœ¡ìƒ ë“±ë¡)
```

### ì‹œí—˜ ì—°ê²° êµ¬ì¡°
```
Exam (ì‹œí—˜)
  â”œâ”€â”€ template_id (í…œí”Œë¦¿ ìˆ˜ì¤€ - ì¬ì‚¬ìš©)
  â”œâ”€â”€ session_id (ì°¨ìˆ˜ ìˆ˜ì¤€ - ì°¨ìˆ˜ ì „ì²´)
  â”œâ”€â”€ division_id (ë¶„ë°˜ ìˆ˜ì¤€ - íŠ¹ì • ë¶„ë°˜)
  â””â”€â”€ is_shared_exam (ë‹¤ì¤‘ ëŒ€ìƒ)
        â”œâ”€â”€ target_sessions[] (ì—¬ëŸ¬ ì°¨ìˆ˜)
        â””â”€â”€ target_divisions[] (ì—¬ëŸ¬ ë¶„ë°˜)
```

### í•µì‹¬ í…Œì´ë¸”

1. **course_templates**: ê³¼ì • í…œí”Œë¦¿ (ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ê³¼ì • ì„¤ê³„)
2. **course_sessions**: ê³¼ì • ì°¨ìˆ˜ (ì‹¤ì œ ìš´ì˜ë˜ëŠ” ê¸°ìˆ˜)
3. **class_divisions**: ë¶„ë°˜ (ê°™ì€ ì°¨ìˆ˜ ë‚´ ë¶„ë°˜) â­
4. **course_enrollments**: êµìœ¡ìƒ ë“±ë¡ (ì°¨ìˆ˜ + ë¶„ë°˜)
5. **question_banks**: ë¬¸ì œì€í–‰
6. **questions**: ë¬¸ì œ
7. **exams**: ì‹œí—˜ â­
8. **exam_questions**: ì‹œí—˜-ë¬¸ì œ ì—°ê²°
9. **exam_attempts**: ì‹œí—˜ ì‘ì‹œ ê¸°ë¡
10. **question_responses**: ê°œë³„ ë¬¸ì œ ì‘ë‹µ

## ğŸš€ ì„¤ì¹˜ ë°©ë²•

### 1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì ìš©

Supabase SQL Editorì—ì„œ ì‹¤í–‰:

```sql
-- 1. ë©”ì¸ ìŠ¤í‚¤ë§ˆ ìƒì„±
\i database/migrations/exam-management-schema.sql

-- 2. (ì„ íƒ) ìƒ˜í”Œ ë°ì´í„° ì‚½ì…
\i database/migrations/exam-management-sample-data.sql
```

### 2. TypeScript íƒ€ì… í™•ì¸

```typescript
// src/types/exam.types.ts í™•ì¸
import type {
  Exam,
  CourseSession,
  ClassDivision,
  ExamEligibleTrainee
} from '@/types/exam.types';
```

## ğŸ“– ì‚¬ìš© ì˜ˆì œ

### 1. ë¶„ë°˜ë³„ ì¼ì¼ í€´ì¦ˆ ìƒì„±

```typescript
// Aë°˜ Quiz (ì˜¤ì „ 10ì‹œ)
const createAClassQuiz = async () => {
  const { data: division } = await supabase
    .from('class_divisions')
    .select('id')
    .eq('division_code', 'BS-SALES-101-2024-3-A')
    .single();

  const { data: exam } = await supabase
    .from('exams')
    .insert({
      title: 'Day 1 Morning Quiz',
      exam_type: 'quiz',
      division_id: division.id,  // Aë°˜ë§Œ ëŒ€ìƒ
      scheduled_at: '2024-10-01 10:00:00',
      duration_minutes: 15,
      passing_score: 70.0,
      total_points: 10.0,
      max_attempts: 2,
      status: 'published'
    })
    .select()
    .single();

  return exam;
};
```

### 2. ì°¨ìˆ˜ ì „ì²´ ìµœì¢…í‰ê°€ (ë¶„ë°˜ í†µí•©)

```typescript
// 3ì°¨ ì „ì²´ êµìœ¡ìƒ ëŒ€ìƒ
const createFinalExam = async () => {
  const { data: session } = await supabase
    .from('course_sessions')
    .select('id')
    .eq('session_code', 'BS-SALES-101-2024-3')
    .single();

  const { data: exam } = await supabase
    .from('exams')
    .insert({
      title: 'BS ì˜ì—… ê¸°ì´ˆê³¼ì • ìµœì¢…í‰ê°€',
      exam_type: 'final',
      session_id: session.id,  // 3ì°¨ ì „ì²´
      scheduled_at: '2024-10-15 10:00:00',
      duration_minutes: 90,
      passing_score: 70.0,
      total_points: 100.0,
      max_attempts: 1,
      randomize_questions: true,
      status: 'published'
    })
    .select()
    .single();

  return exam;
};
```

### 3. ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒì ì¡°íšŒ

```sql
-- View ì‚¬ìš© (ê°„ë‹¨)
SELECT *
FROM v_exam_eligible_trainees
WHERE exam_id = :exam_id
ORDER BY division_name, trainee_name;

-- ë˜ëŠ” ì§ì ‘ ì¿¼ë¦¬ (ìƒì„¸ ì œì–´)
WITH exam_targets AS (
    SELECT
        e.id as exam_id,
        CASE
            WHEN e.division_id IS NOT NULL THEN ARRAY[e.division_id]
            WHEN e.session_id IS NOT NULL THEN
                (SELECT array_agg(id) FROM class_divisions WHERE session_id = e.session_id)
            WHEN e.is_shared_exam AND e.target_divisions IS NOT NULL THEN
                e.target_divisions
            ELSE ARRAY[]::UUID[]
        END as target_division_ids
    FROM exams e
    WHERE e.id = :exam_id
)
SELECT DISTINCT
    u.id,
    u.name,
    u.email,
    cs.session_name,
    cd.division_name
FROM users u
INNER JOIN course_enrollments ce ON u.id = ce.trainee_id
INNER JOIN course_sessions cs ON ce.session_id = cs.id
LEFT JOIN class_divisions cd ON ce.division_id = cd.id
CROSS JOIN exam_targets et
WHERE
    ce.status = 'active'
    AND u.role = 'trainee'
    AND (
        (ce.division_id IS NOT NULL AND ce.division_id = ANY(et.target_division_ids))
        OR (ce.division_id IS NULL AND cs.id = (SELECT session_id FROM exams WHERE id = :exam_id))
    );
```

### 4. ì‹œí—˜ ì‘ì‹œ ì „ì²´ í”Œë¡œìš°

```typescript
// Step 1: ì‘ì‹œ ì‹œì‘
const startExam = async (examId: string, traineeId: string) => {
  const { data: attempt } = await supabase
    .from('exam_attempts')
    .insert({
      exam_id: examId,
      trainee_id: traineeId,
      attempt_number: 1,
      started_at: new Date().toISOString(),
      status: 'in_progress'
    })
    .select()
    .single();

  return attempt;
};

// Step 2: ë‹µì•ˆ ì œì¶œ
const submitExam = async (attemptId: string, answers: Record<string, any>) => {
  const { data: attempt } = await supabase
    .from('exam_attempts')
    .update({
      submitted_at: new Date().toISOString(),
      answers: answers,
      status: 'submitted'
    })
    .eq('id', attemptId)
    .select()
    .single();

  return attempt;
};

// Step 3: ìë™ ì±„ì  (ê°ê´€ì‹/O/X)
const autoGrade = async (attemptId: string) => {
  // 1. ê° ë¬¸ì œë³„ ì±„ì 
  const { data: responses } = await supabase
    .from('question_responses')
    .select(`
      id,
      answer,
      question:questions(id, type, correct_answer, points)
    `)
    .eq('attempt_id', attemptId);

  for (const response of responses!) {
    if (response.question.type === 'multiple_choice' ||
        response.question.type === 'true_false') {
      const isCorrect = JSON.stringify(response.answer) ===
                        JSON.stringify(response.question.correct_answer);

      await supabase
        .from('question_responses')
        .update({
          is_correct: isCorrect,
          points_earned: isCorrect ? response.question.points : 0
        })
        .eq('id', response.id);
    }
  }

  // 2. ì´ì  ê³„ì‚°
  const { data: totalPoints } = await supabase
    .rpc('calculate_attempt_score', { p_attempt_id: attemptId });

  // 3. í•©ê²© ì—¬ë¶€ íŒì •
  const { data: exam } = await supabase
    .from('exam_attempts')
    .select('exam:exams(passing_score, total_points)')
    .eq('id', attemptId)
    .single();

  const scorePercentage = (totalPoints / exam.exam.total_points) * 100;
  const passed = scorePercentage >= exam.exam.passing_score;

  await supabase
    .from('exam_attempts')
    .update({
      score: totalPoints,
      score_percentage: scorePercentage,
      passed: passed,
      status: 'graded'
    })
    .eq('id', attemptId);
};
```

### 5. ë¶„ë°˜ë³„ ì„±ì  í†µê³„ ì¡°íšŒ

```sql
-- View ì‚¬ìš©
SELECT *
FROM v_exam_statistics
WHERE exam_id = :exam_id
ORDER BY division_name;

-- ë˜ëŠ” ì§ì ‘ ì¿¼ë¦¬
SELECT
    cd.division_name,
    COUNT(DISTINCT ea.trainee_id) as total_takers,
    ROUND(AVG(ea.score), 2) as avg_score,
    COUNT(CASE WHEN ea.passed THEN 1 END) as pass_count,
    ROUND(
        COUNT(CASE WHEN ea.passed THEN 1 END)::numeric /
        NULLIF(COUNT(*), 0) * 100,
        2
    ) as pass_rate
FROM exams e
LEFT JOIN exam_attempts ea ON e.id = ea.exam_id AND ea.status = 'graded'
LEFT JOIN course_enrollments ce ON ea.trainee_id = ce.trainee_id
LEFT JOIN class_divisions cd ON ce.division_id = cd.id
WHERE e.id = :exam_id
GROUP BY cd.division_name;
```

## ğŸ” ì£¼ìš” ì¿¼ë¦¬ íŒ¨í„´

### êµìœ¡ìƒì´ ì‘ì‹œ ê°€ëŠ¥í•œ ì‹œí—˜ ëª©ë¡

```typescript
const getAvailableExams = async (traineeId: string) => {
  const { data } = await supabase
    .from('v_exam_eligible_trainees')
    .select(`
      exam_id,
      exam_title,
      exams (
        exam_type,
        scheduled_at,
        duration_minutes,
        passing_score,
        status
      )
    `)
    .eq('trainee_id', traineeId)
    .eq('exams.status', 'published');

  return data;
};
```

### êµìœ¡ìƒ ì‹œí—˜ ì´ë ¥

```typescript
const getTraineeExamHistory = async (traineeId: string) => {
  const { data } = await supabase
    .from('exam_attempts')
    .select(`
      attempt_number,
      score,
      score_percentage,
      passed,
      submitted_at,
      exam:exams (
        title,
        exam_type,
        session:course_sessions (session_name),
        division:class_divisions (division_name)
      )
    `)
    .eq('trainee_id', traineeId)
    .eq('status', 'graded')
    .order('submitted_at', { ascending: false });

  return data;
};
```

## ğŸ› ï¸ ì„œë¹„ìŠ¤ ë ˆì´ì–´ ì˜ˆì œ

ì™„ì „í•œ ì„œë¹„ìŠ¤ ë ˆì´ì–´ëŠ” `src/services/exam.services.ts`ì— êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.

```typescript
// ì˜ˆì œ ì„œë¹„ìŠ¤ ë©”ì„œë“œ
class ExamService {
  // ì‹œí—˜ ìƒì„±
  async createExam(data: CreateExamData): Promise<Exam> { }

  // ì‹œí—˜ ëŒ€ìƒì ì¡°íšŒ
  async getEligibleTrainees(examId: string): Promise<ExamEligibleTrainee[]> { }

  // ì‹œí—˜ ì‘ì‹œ
  async startAttempt(examId: string, traineeId: string): Promise<ExamAttempt> { }
  async submitAttempt(attemptId: string, answers: Record<string, any>): Promise<void> { }

  // ì±„ì 
  async autoGrade(attemptId: string): Promise<void> { }
  async manualGrade(data: GradeExamAttemptData): Promise<void> { }

  // í†µê³„
  async getExamStatistics(examId: string): Promise<ExamStatistics[]> { }
  async getTraineeHistory(traineeId: string): Promise<TraineeExamHistory[]> { }
}
```

## ğŸ“Š ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ê²½ìš°:

1. **course_templates ìƒì„±**: ê¸°ì¡´ coursesë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ë³€í™˜
2. **course_sessions ìƒì„±**: ê¸°ì¡´ coursesë¥¼ ì°¨ìˆ˜ë¡œ ë³€í™˜ (1:1 ë˜ëŠ” 1:N)
3. **class_divisions ìƒì„±**: í•„ìš”ì‹œ ë¶„ë°˜ ì •ë³´ ì¶”ê°€
4. **course_enrollments ì—…ë°ì´íŠ¸**: division_id ì»¬ëŸ¼ ì¶”ê°€ ë° ë°ì´í„° ì—°ê²°

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **RLS ì •ì±…**: Production í™˜ê²½ì—ì„œëŠ” ë°˜ë“œì‹œ RLS ì •ì±… ê²€í†  í•„ìš”
2. **ì¸ë±ìŠ¤**: ëŒ€ìš©ëŸ‰ ë°ì´í„°ì˜ ê²½ìš° ì¶”ê°€ ì¸ë±ìŠ¤ ê³ ë ¤
3. **íŠ¸ëœì­ì…˜**: ì¤‘ìš”í•œ ì‘ì—…(ì±„ì , ë“±ë¡ ë“±)ì€ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê¶Œì¥
4. **íƒ€ì„ì¡´**: ëª¨ë“  ì‹œê°„ì€ UTC ê¸°ì¤€, UIì—ì„œ ë¡œì»¬ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
5. **JSONB ê²€ì¦**: answers, options ë“± JSONB í•„ë“œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê²€ì¦ í•„ìˆ˜

## ğŸ“š ì¶”ê°€ ë¦¬ì†ŒìŠ¤

- [Supabase ê³µì‹ ë¬¸ì„œ](https://supabase.com/docs)
- [PostgreSQL JSONB ë¬¸ì„œ](https://www.postgresql.org/docs/current/datatype-json.html)
- [LMS ë°ì´í„° ëª¨ë¸ Best Practices](https://en.wikipedia.org/wiki/Learning_management_system)

## ğŸ¤ ê¸°ì—¬

ë²„ê·¸ ë¦¬í¬íŠ¸ë‚˜ ê¸°ëŠ¥ ì œì•ˆì€ ì´ìŠˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.

---

**ìƒì„±ì¼**: 2025-10-24
**ë²„ì „**: 1.0.0
**ì‘ì„±ì**: BS Learning Team
