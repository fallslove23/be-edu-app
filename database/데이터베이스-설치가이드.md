# 📦 BS 학습 관리 시스템 - 데이터베이스 설치 가이드

현재 프로젝트에서 필요한 모든 데이터베이스 테이블 설치 가이드입니다.

## 🚨 중요: Mock Auth 사용

현재 프로젝트는 Mock Authentication을 사용하므로, **RLS가 비활성화된 `-mock-auth` 버전**의 마이그레이션 파일을 사용해야 합니다.

## 📋 필수 설치 항목

### 1️⃣ 알림 시스템 (Notification System) ⚠️ **현재 오류 발생 중**

**파일**: `database/migrations/create-notification-system-mock-auth.sql`

**설치 방법**:
1. Supabase 대시보드 → SQL Editor
2. New query 클릭
3. 파일 내용 복사 & 붙여넣기
4. RUN 버튼 클릭

**생성되는 테이블**:
- ✅ `notifications` - 사용자 알림
- ✅ `notification_preferences` - 알림 설정
- ✅ `scheduled_notifications` - 예정 알림

**확인 방법**:
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('notifications', 'notification_preferences', 'scheduled_notifications');
```

---

### 2️⃣ 커리큘럼 템플릿 시스템 ⚠️ **현재 오류 발생 중**

**파일**: `database/migrations/create-curriculum-templates-mock-auth.sql`

**설치 방법**:
1. Supabase 대시보드 → SQL Editor
2. New query 클릭
3. 파일 내용 복사 & 붙여넣기
4. RUN 버튼 클릭

**생성되는 테이블**:
- ✅ `curriculum_templates` - 시간표 템플릿
- ✅ `curriculum_template_sessions` - 템플릿 세션 상세

**확인 방법**:
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('curriculum_templates', 'curriculum_template_sessions');
```

---

## 🎯 빠른 설치 (모든 테이블 한번에)

### Option 1: 개별 설치 (권장)

위의 1️⃣, 2️⃣ 순서대로 각각 설치

### Option 2: 통합 설치

아래 SQL을 한번에 실행:

```sql
-- 1. 알림 시스템 테이블
\i database/migrations/create-notification-system-mock-auth.sql

-- 2. 커리큘럼 템플릿 테이블
\i database/migrations/create-curriculum-templates-mock-auth.sql
```

> **참고**: Supabase SQL Editor에서는 `\i` 명령어를 지원하지 않으므로, 각 파일 내용을 순차적으로 복사하여 실행해야 합니다.

---

## ✅ 설치 확인

모든 테이블이 정상적으로 생성되었는지 확인:

```sql
SELECT
  table_name,
  CASE
    WHEN table_name IN ('notifications', 'notification_preferences', 'scheduled_notifications')
      THEN '알림 시스템'
    WHEN table_name IN ('curriculum_templates', 'curriculum_template_sessions')
      THEN '커리큘럼 템플릿'
    ELSE '기타'
  END as system_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN (
  'notifications',
  'notification_preferences',
  'scheduled_notifications',
  'curriculum_templates',
  'curriculum_template_sessions'
)
ORDER BY system_name, table_name;
```

**예상 결과**: 5개의 테이블이 표시되어야 함

---

## 🔍 문제 해결

### 문제 1: "relation does not exist" 오류

**원인**: 테이블이 생성되지 않았거나 이름이 잘못됨

**해결**:
1. 위의 설치 확인 SQL 실행
2. 누락된 테이블 확인
3. 해당 마이그레이션 파일 다시 실행

### 문제 2: RLS 정책 오류

**원인**: Mock Auth가 아닌 일반 버전 파일을 실행함

**해결**:
```sql
-- RLS 비활성화
ALTER TABLE notifications DISABLE ROW LEVEL SECURITY;
ALTER TABLE notification_preferences DISABLE ROW LEVEL SECURITY;
ALTER TABLE scheduled_notifications DISABLE ROW LEVEL SECURITY;
ALTER TABLE curriculum_templates DISABLE ROW LEVEL SECURITY;
ALTER TABLE curriculum_template_sessions DISABLE ROW LEVEL SECURITY;
```

### 문제 3: 외래 키 오류

**원인**: 관련 테이블이 먼저 생성되어 있지 않음

**필수 선행 테이블**:
- `users` (사용자)
- `course_rounds` (과정)
- `course_sessions` (일정)
- `round_enrollments` (등록)
- `subjects` (과목)

**해결**: 필수 테이블을 먼저 생성한 후 다시 실행

### 문제 4: 브라우저에서 여전히 오류 발생

**해결**:
1. 브라우저 새로고침 (F5 또는 Cmd/Ctrl + R)
2. 브라우저 캐시 삭제 (Cmd/Ctrl + Shift + R)
3. 개발 서버 재시작 (`npm run dev`)

---

## 📊 데이터베이스 구조 확인

### 전체 테이블 목록 보기

```sql
SELECT
  schemaname,
  tablename,
  tableowner
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;
```

### 테이블 컬럼 구조 보기

```sql
-- 예: notifications 테이블 구조
SELECT
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_schema = 'public'
AND table_name = 'notifications'
ORDER BY ordinal_position;
```

---

## 📚 추가 문서

- **알림 시스템 상세**: [README-NOTIFICATION-SYSTEM.md](./README-NOTIFICATION-SYSTEM.md)
- **커리큘럼 관리**: CurriculumManager.tsx 컴포넌트 참조

---

## 📞 지원

설치 중 문제가 발생하면:
1. 브라우저 콘솔(F12)에서 오류 메시지 확인
2. Supabase 대시보드 → Logs에서 데이터베이스 오류 확인
3. 프로젝트 이슈 트래커에 버그 리포트

---

## ⚡ 설치 완료 후

설치가 완료되면:
1. 브라우저 새로고침
2. 헤더의 알림 벨 아이콘 확인
3. 커리큘럼 관리 페이지에서 템플릿 기능 사용 가능
